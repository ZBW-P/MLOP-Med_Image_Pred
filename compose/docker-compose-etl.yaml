name: upload-merged-dataset

volumes:
  mergeddata:

services:
  extract-data:
    container_name: extract_merged_data
    image: python:3.11
    user: root
    volumes:
      - mergeddata:/data
    working_dir: /data
    command:
      - bash
      - -c
      - |
        set -e
        echo "Creating target directory..."
        rm -rf merged_dataset
        mkdir -p merged_dataset
        cd merged_dataset
        # curl -L https://nyu.box.com/shared/static/vj63o013r3pep3fklidza32ijxuullc3.zip \
        # curl -L https://nyu.box.com/shared/static/vj63o013r3pep3fklidza32ijxuullc3.zip -o merged_dataset.zip
        curl -L -o merged_dataset.zip "https://nyu.box.com/shared/static/vj63o013r3pep3fklidza32ijxuullc3.zip"
        # curl -L "https://dl.boxcloud.com/d/1/b1!aw20kJc28bXC02rYEEYaEwFUxn5rrAl_2Mtl0URFsGjrRc-g_2lbPz8-v-XxtFXszpzStNFAeL1MDBlzjFtegomt5KJ-meB9GOSDACX-vduEcFjlLrkmbeRMs2wfXmDxXaGqqJ-xZuidL_41Cdp3PFJkVG8BkAycU-qugAe7mnjBkemaKEoz4CbeJncYXh8PIVZlC_8_cQIoPY4RFOkm181SXa2DHEWlb69Rwa5BGwgf3jCgx1BkRgRPYNq0t6C_ldo16y1q65tjQoKT3Oevii_tcNuE6r0zQWYmwQK2B_hLmycm5oehqTrk2ftCD57Wjmziqab_Uj0Av5gWvV-QhKMzzyFYDCSASaKhZYGAYRHjZvTVLfTc3f1mwtFqVah8pu3fsZaVQmr0p7GaEf1LRlLDoT4eKNcIFB4hfEY8mUOnPZauIc4LcnCxffYVE8YlyMv43E7TjzyKTJ5Tiy2cBN7-E0aM7s5Vcvyz3rmXd6PcVy5aqjoS0-vTM481imBJWZlkieDoJkm9D-LlQL2bSguoYkKZ0gvWXeD-LfXH5-yNat3xYpS0N44VyapC0Dzt6vYf6KQ4d9OLnvVMU_QG1iCahAse3Q2yLsVEAiYTwpRqLQcbriYNONsn4vuwRhsCLgDIlm4q8qNfgRN7A5dJqlVJWnGeqmqv9Vdol02Jq0Ax2KATwAQn4L7_0fk5I3bfipzcSR8-IG_0_tuqIXIF-znVOeM2rBXCxfObSjzKVfAuzK6RBe55ombMwstaRLA23wLdPBwvi_5YCzQ62-QXltQ3kQRSo99oCEm_akzu-eClamZH91YgNUUugcOX6vcuV6ZI4dFkXYSKPVs1ii2WwIFmPhfZIJF-JLxqOxfCow5TJULy7nV9dUH0mWyTbRyNok6T_E79EjqeXE9kc38HUAcdudra3S_RcHfP_zQSVCQtrUfoq2oNLBXMxkhO4JA736z2SGhVmAUwD78Z8CDvPWjlVWSVhADqftKQZfmFf_yTGlc8xko2WDixCvYxRfCZX6GisR2uxNl8N7l0qFvtxfXeDg9bU9IQEVi0T9pqSwWoVg48-FhFsahvwaMa-O3hH76NdAFiyV-0Z2Sf0YVFHXs5KXjK9saN4ohv9JQedRYT_FxTS1_SDdb4xT3M28HY4VigDXDk1rszvGZEE9iuhIbE-5kB0PqpnrkVTvz4Gz6b-w7tYwPA7I83bHwHLaFwawsV4Iy4QJ9sLGchcEeM553R1gvq3F4-58uLPzuyv3MzEbw4_gL9CVdtX5Qe0mNyV78U26n60lt4o7YP14FLaEsGovnzeviASr7iEBz5tSkeSmyb5vxc7dYX5GifnoZGFEkCDOOmyOYmJeAelitnD52-piBIbC2SUimiKhPEWoqrFe73FssdBu0EwgRwU5-4ah3lBQLfux-_GPI2EPzeKwW8_nZPKdtaQXDltF2u9P97xYAWwk6sbSoCfAlcagsTR5Vk3jQdD0PO269GBdJ088EzIE3-JU4qS8oeCGAs-H8s-ejFhA../download" -o merged_dataset.zip

        echo "Unzipping..."
        unzip -q merged_dataset.zip -d /data/merged_dataset
        rm -f merged_dataset.zip

        echo "Listing contents of /data after extract stage:"
        ls -l /data/merged_dataset

  load-data:
    container_name: upload_merged_data
    image: rclone/rclone:latest
    volumes:
      - mergeddata:/data
      - ~/.config/rclone/rclone.conf:/root/.config/rclone/rclone.conf:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        if [ -z "$RCLONE_CONTAINER" ]; then
          echo "ERROR: RCLONE_CONTAINER is not set"
          exit 1
        fi

        echo "Cleaning up existing contents of object store..."
        rclone delete chi_tacc:$RCLONE_CONTAINER --rmdirs || true

        echo "Uploading /data/merged_dataset to object store..."
        rclone copy /data/merged_dataset chi_tacc:$RCLONE_CONTAINER \
          --progress \
          --transfers=32 \
          --checkers=16 \
          --multi-thread-streams=4 \
          --fast-list

        echo "Upload complete. Listing contents:"
        rclone lsd chi_tacc:$RCLONE_CONTAINER
