name: upload-merged-dataset

volumes:
  mergeddata:

services:
  extract-data:
    container_name: extract_merged_data
    image: python:3.11
    user: root
    volumes:
      - mergeddata:/data
    working_dir: /data
    command:
      - bash
      - -c
      - |
        set -e
        echo "Creating target directory..."
        rm -rf merged_dataset
        mkdir -p merged_dataset
        cd merged_dataset
        curl -L "https://dl.boxcloud.com/d/1/b1!aFGdVAVcDLCyNoy8KKojYmtAfepG5WN_QN6eymW2sXod1_x7sBEw9VjqKbuXdPYVlQwbqtC4pVvZfOQ4zlewRPMxleG48uvMN7272F1WtGZHlG7JI7iNau4deTx3d8hq8FekwiC8gpj7DyLcemxG3HJaww1JIuHxXpscsPqeqZ7Qo0_N4dKjgFqyAKcQCL4SS78scXu5wcZJnJsw9WupehY1HiMdMdsTNohQjRf9dCJfg1JjHsOEdQuVFfVBc42Zsc-e-GeJ5vtZ4DSiajBZEsWwq38gRB3_IxebMJkyTFpC0MJd0PgYA0N6cup_0UogFYDe1Sgl4N6PS3i1r5S5jRF0EWqCGz1Vpk28v92GHEvl00B6iZDnJ2Vael1iTyL9mcaWMesOaKW6KLprPOnrfDs_OXwg95qamiuTzbvrMUGgZCheyf2IGX6BRptF3_ehog7GmRdS-edcbuc-IHCghlbncKnbSP7uIyNEb5o2jyMUCpplwCff9CuJK_PL7H7PIAQvLvPTv0w_FBEefeHL0csZ6rYtxsOpO8OUFPS8_aSB7VC5k2R7HUwqdrT3dEmx22tqN9-Xm1NxaiiwnnPibcsTaWS65q7WtAN1C2a9XNgNbxKtlLj6szLIM_BxVCS4BMaU-idxsr79_vOBA3Q3ikkMfgKo0ihTf0xoXMMvli8-YDRhb_Svr_qi7TaMP27oHETuKcgOGgQ1tjOmgLLmhSffQJePBNOdcSIa51DvDzpv5IRuQYiE5Q3Quva0OjNvTB_6SBCkJKo_u_djGNf9J4UghNO0X1QK1RIRdM9T4JTLdm32M-3V11PsCGyreIx51xzR5T5M93LvdiFsB4F8IQPVT6ZMoceJMWwq7e6ALxOnyNP5qBiWc-lLs_kLE2mJ-IjUdJCZ-1hjVZsVDu3BFA43KaP8ezLAKrDXxDqofp-hKD4ZFDW6hqyHmvSSON8gOkzOgAJNcNamr4jFBXtX9j8FB8DGiNZ72dHc7W-XK-QYr8Pl1Xu1ohrXe0f1KeTunuMzguIHzYAGWZAVbtPu-FrTOqVJK7SZ8xwS285bTq6pELd6sjTNJbErt5IuSspn_7sqDDyc3a1DZANKzSE8WiDGSN2PC7LEcRjATbA_2n3vF84goK587XVlicU79mf-ys2VdagZxwYF-1eInEBfExMzNqUv4hVI70VGCmo_5y-lqcVpIHegTeDj_8o6ACQQMnUJjS_UmYupa5dTXwSC4-HH8L3KUcL0TXP7A8SAED0RlSJhBywElQ0TgYwwiBTMtik7XCniOYT7s-RYYHmrAEmsnQRaT91ouXnJiAnYtiWgU-XinCBgZ-viAOD9jEAaEikAEugc7e963nmuIn-UYCU435nnRmN4oCS-7F3zOmojwidovK3EPzqYkREGPt7w4chdyI9He3U5Q3sQP_rm/download" -o merged_dataset.zip
        echo "Downloading merged_dataset.zip from NYU Box..."
       
        echo "Unzipping..."
        unzip -q merged_dataset.zip -d /data/merged_dataset
        rm -f merged_dataset.zip

        echo "Listing contents of /data after extract stage:"
        ls -l /data/merged_dataset

  load-data:
    container_name: upload_merged_data
    image: rclone/rclone:latest
    volumes:
      - mergeddata:/data
      - ~/.config/rclone/rclone.conf:/root/.config/rclone/rclone.conf:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        if [ -z "$RCLONE_CONTAINER" ]; then
          echo "ERROR: RCLONE_CONTAINER is not set"
          exit 1
        fi

        echo "Cleaning up existing contents of object store..."
        rclone delete chi_tacc:$RCLONE_CONTAINER --rmdirs || true

        echo "Uploading /data/merged_dataset to object store..."
        rclone copy /data/merged_dataset chi_tacc:$RCLONE_CONTAINER \
          --progress \
          --transfers=32 \
          --checkers=16 \
          --multi-thread-streams=4 \
          --fast-list

        echo "Upload complete. Listing contents:"
        rclone lsd chi_tacc:$RCLONE_CONTAINER
