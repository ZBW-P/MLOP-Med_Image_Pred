name: upload-merged-dataset

volumes:
  mergeddata:

services:
  extract-data:
    container_name: extract_merged_data
    image: python:3.11
    user: root
    volumes:
      - mergeddata:/data
    working_dir: /data
    command:
      - bash
      - -c
      - |
        set -e
        echo "Creating target directory..."
        rm -rf merged_dataset
        mkdir -p merged_dataset
        cd merged_dataset

        echo "Downloading merged_dataset.zip from NYU Box..."
        curl -L 'https://dl.boxcloud.com/d/1/b1!D_F4_K5-VgvyU5goMTYBcsnYycSeKEwSOaPbehQs92HdVmBgk0EpA9svjuZcohYLK3Ift_J6gzZGnDf2AaRig2jCKe0W7gaIUJv0C2295-wEKa37JY2Fg3UmCT3xbGJ-mTSGCGnxdkuOHHVd83KYltmGkyaavb9pN2TMB3siOHZ7Gaf2h01iYO00VeHCgmZAa1yO1u73GAWjNNjJ3d_VpkRPupdhzicQQEiKmge8043A-pusi2p7BRgcGgNwN8rd1x_xtudn7IdloQAsm3xcD7wGQglSYEG7wKH38epZKFJaG5PjJR0a54lCiTAPsMZw-YMURw69K-cvq9llKBV0iitrp-oF-CYyjipyfH9OK2iLqx4sc18rpV_FyNQ_n8BGmvyGBhAmqkaPmVTzYOvxtwtPY_U2qqFLoSyZZD_-LVFKe_y2OMoUWgpdd7WjMIJlvU4nWHPshA33Ir26Ty-UV1f1lzzbZFjvjUzqWBUBiTPiJ6pCwiBjaisG1XXGZsYLAgnAz0Rg6hCw9Cz35eHwJSTwC9LtLGPwFBDcMvOtzKHVkTptRVMfV9R_zFuALvNutwpF8gr_8BKnC-pxONV7s5LUlRAsJAccYx7Jw7SjeHlpA_5gtD2WSRe4VPz7IKtbs_lOy46JMnTKfbeqK5TjIm9Yauzdh1aAdCQOEGGYcJXcAbDGb4h_kluDEQ0IprxzQSZTaOTMSZ4d3dkXq1j3sLj8FaqfS5HAfoChjtJ-Ds5jN9nCNw4wZ20WEFYDZ5cFVGC3YEEGJikKbg6S0qx5xeEPaIH0lHp9pUc5foTtpYAWwtad9D-5OaHmsWjWaonqhixv_PtOq8ZkrDKcxL0nWv8YWI4M8A3aPakwYUEkmhLfztH_V5UYcpaENt-3JuoBBuHyUWNeMY3CH-hxR9ozb49To9RF17dR-hVG0AuP1CGL-_DgjLsaWwzAPDPX-yA4cEbJ404xc0LjqZMdcXxWymCxOGZFl-lyJJZGjMxXEMhswUr6cdpPisp3maTzZ6wqXLe9VeE5ZrEc4NnC4JzPqtVeh3pqCZl1oDKJxH3kJe8frNiTKseM3Sl2aN9JYqtZDm5U6JvxaY6dH1O21OcexTP_dpIcFpnznVLb-JSVqU0bAQ2SBIBHWCvl2FiuvpA3WxhR4DApQSCl2rbrDNfoXCUlxM-irc_K933SsNSB-sS0QU76LVwGuU0rROpT3dCoIeruEPeHlsQFLZb0S1IFNYa6wqh9rK0d7-_HZxBNy5Wk2XEwMPOi8zL7Q9KHJhnJiF8S24McMu0adrohPCf8rMIW2517YraO0gL3tePHOxRCqR5wxCqokD4iD0AJxGsDMYYX3ySnDcKHiKM4f_Na6tmUHws3YbFabx2gdxwomBpVq-HIyhRFTDpJCdU08qZw0yvsBQTbJXdVr0XHcIvG/download' \
          -o merged_dataset.zip
        echo "Unzipping..."
        unzip -q merged_dataset.zip
        rm -f merged_dataset.zip

        echo "Listing contents of /data after extract stage:"
        ls -l /data/merged_dataset

  load-data:
    container_name: upload_merged_data
    image: rclone/rclone:latest
    volumes:
      - mergeddata:/data
      - ~/.config/rclone/rclone.conf:/root/.config/rclone/rclone.conf:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        if [ -z "$RCLONE_CONTAINER" ]; then
          echo "ERROR: RCLONE_CONTAINER is not set"
          exit 1
        fi

        echo "Cleaning up existing contents of object store..."
        rclone delete chi_tacc:$RCLONE_CONTAINER --rmdirs || true

        echo "Uploading /data/merged_dataset to object store..."
        rclone copy /data/merged_dataset/ chi_tacc:$RCLONE_CONTAINER \
          --progress \
          --transfers=32 \
          --checkers=16 \
          --multi-thread-streams=4 \
          --fast-list

        echo "Upload complete. Listing contents:"
        rclone lsd chi_tacc:$RCLONE_CONTAINER
