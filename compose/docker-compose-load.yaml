name: upload-merged-dataset

volumes:
  mergeddata:

services:
  extract-data:
    container_name: extract_merged_data
    image: python:3.11
    user: root
    volumes:
      - mergeddata:/data
    working_dir: /data
    command:
      - bash
      - -c
      - |
        set -e
        echo "Creating target directory..."
        rm -rf merged_dataset
        mkdir -p merged_dataset
        cd merged_dataset

        echo "Downloading merged_dataset.zip from NYU Box..."
        curl -L 'https://dl.boxcloud.com/d/1/b1!UTnle0Hrge87SyYhLMRBBTfdO4PkrVPZi-AUZuxG5myUDiqkjTx0nhfc_VGN4OzLGZEDwXjpjIrF12ajudHYwIKhtTXYFM7wi7uav3IxXMdskr2lS1Oxr8rAQsHhdMLgtATbPg-frwzwJkJOOirD4x33PTZLhFCRLKl-iYSv79tbVBkMQ6CqhB7ii9pZlosZLbV4nxnMc2YLP_8MfNbR1elzu_3NLQotSLBqMe4Oh5EjaP4Y0Q8X9AuFPlJYWdDFyWdhJl4SNZL3uW6ipqY7SWwlpNpwTxHDrtDhRfwfh7D_A2J0VUz8GqPAb0eqiv85J8d0Mazjy1fuOmnMxD7-9xIK_pjH9ZNc61DopJN09DyQ1lxGnbkwn7hvU7iWqyvg3sGdzlu9e67hduvrncvUo8Ga1h4pWlH3ELTxOVk9H-DdOsQVCJjsl7Yamt2o2-__AMuKVyUFV4gK1eCmJydWh_LvG_NWBYzXwXgNsjAlIbaijofYOZPgFPU5KWNRyIwcPjchJmi0tD3QszLqUEcIJpdEPDfqx97U9obE1twnDjLHQY4pGM0RmFmJj25JGuJl6VoGC5_Er6XHAj7k4frSkHTBnu2vR7H-K79WQVY5fA2A1bB-OY5mrWntem0_TiMPpWpYfCqpblwpttBNGe1SEJeE4YbZxWSIYP9JBEq2nLEOTC8Aj6hMJacYq3PGxQKXrt8oQ6tIsebmeJlsDWeYZEg2pNnvGYKpA3QQi3KAhfC32ls9hOo1ZP0r6EtmqSKHoWBj3zFOVX2pBvhskhNUv-7l4Sji0UeGBKEl504ksbbO-NQ2cKfkf0kEXwZYIRCWhRGav_gvzvxnYJBtnHnfFUDIFjRdzUa47mWXM_BqaSjs5s8dah-tp_u8htyo0itMH_0BbsReLrzJ3-0oPBzHt4GIvbZb9ecvhSQfa3eUZ0IIJrlOS-BtnwTK7jfxwDf5-ui9PrM4Wo1xdkjBs1IodVnZNCjEN8bP4js_FYHwOsDud_EXW9FyJAtPz-1SZHNDSWmz8IbMa8VHM8RRb0oRa9ePsm5GASgbOAgIqsk2qiaVl-4B2XrBvUQWwhQNyDBoX9qJ5AysSkkeNaG_D0NopwkyT5HR8p6Jh3JRFzlxczunzK6wD4BS1hW7oYYh2Dg-AP-v1DWksncQPXoq3nUcGHBZNRCQs6GUXJfnvmxN-Jn8PQ1dWhvxFBPQCrbbdm5SdeiqxitqDn1FFpwNsfLcztqXwpqZNJBprkEy8_BzGXUKiMt-UkETj1e6GjhTM7giEIIU9uzR2RjkEjb7PsBR5bhNKh2wAcceO-r8oflIrrwGNXNLZfj5zxZrVKvi_bf-dQxUVfkrsZUE19FgR3oadZGtnrYOdoibJpBOzxFnUteIkJeXppU389EfbwQnfxwJXkwmAuX9f10fwWcQM0Nrf5JeDLwq4GKfz0Nv2L72ssUWYfGX5QJnifMGRdbidh3UxnTuORwEYhoyA5iIieBR5Eyb3G8JleCDVdvybujXkUPKVSwbqIbp/download' -o merged_dataset.zip
        echo "Unzipping..."
        unzip -q merged_dataset.zip
        rm -f merged_dataset.zip

        echo "Listing contents of /data after extract stage:"
        ls -l /data/merged_dataset

  load-data:
    container_name: upload_merged_data
    image: rclone/rclone:latest
    volumes:
      - mergeddata:/data
      - ~/.config/rclone/rclone.conf:/root/.config/rclone/rclone.conf:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        if [ -z "$RCLONE_CONTAINER" ]; then
          echo "ERROR: RCLONE_CONTAINER is not set"
          exit 1
        fi

        echo "Cleaning up existing contents of object store..."
        rclone delete chi_tacc:$RCLONE_CONTAINER --rmdirs || true

        echo "Uploading /data/merged_dataset to object store..."
        rclone copy /data/merged_dataset/. chi_tacc:$RCLONE_CONTAINER \
          --progress \
          --transfers=32 \
          --checkers=16 \
          --multi-thread-streams=4 \
          --fast-list

        echo "Upload complete. Listing contents:"
        rclone lsd chi_tacc:$RCLONE_CONTAINER
